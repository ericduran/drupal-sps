<?php

use Drupal\sps\Exception as SPSException;

class SPSPluginUnitTest extends SPSBaseUnitTest {
  static function getInfo() {
    return array(
      'name' => 'SPS Plugin Unit Tests',
      'description' => 'SPS Plugin Tests.',
      'group' => 'SPS',
    );
  }

  public function testPluginFactory() {
    try {
      $factory = sps_get_plugin_factory();
      $this->pass('Plugin Factory Loaded', "SPS");
      return;
    } catch (\SPSException\ClassLoadException $e) {
      $this->fail('Plugin Factory Loaded', "SPS");
      return;
    } catch (Exception $e) {
      $this->fail('Plugin Factory Loaded', "SPS");
      $this->fail('Plugin Factory Exception was not used', "SPS");
      return;
    }
  }

  public function testPluginTypes() {
    try {
      $plugin_type = sps_get_plugin_type("fake_plugin");
    } catch (\SPSException\ClassLoadException $e) {
      $this->pass("Fake Plugin Type not Loaded", "SPS");
    }

    try {
      $plugin_type = sps_get_plugin_type("test_type");
    } catch (\SPSException\ClassLoadException $e) {
      $this->fail("Load Plugin Type", "SPS");
    }

    $this->assertCheckInterface("Drupal\\sps\\Plugin\\PluginTypeInterface",
      $plugin_type, "Plugin Type is using the correct interface");

  }


  public function testPluginLoading() {
    try {
      $plugin = sps_get_plugin('not_valid_type', 'not_valid_key');
      $this->fail("Plugin Not Loaded", "SPS");

    } catch (\Drupal\sps\Exception\InvalidPluginException $e) {
      $this->pass("Plugin Not Loaded", "SPS");
    }

    try {
      $plugin = sps_get_plugin('test_type', 'test_type_1');
      $this->pass("Plugin Loaded", "SPS");
    } catch (Drupal\sps\Exception\InvalidPluginException $e) {
      $this->fail("Plugin loaded", "SPS");
    }

    $plugin_type = sps_get_plugin_type('test_type');
    $plugin_2 = sps_get_plugin('test_type', 'test_type_2');
    $this->assertTrue($plugin_2 instanceof $plugin_type->getDefaultPluginClass(), "Default Plugin Loaded");

    $this->assertIsPlugin($plugin);
    $this->assertIsPlugin($plugin_2);

    $plugins = sps_get_plugin('test_type');
    $this->assertTrue($plugins instanceof \Drupal\sps\Plugin\PluginCollection,
      "Plugin Collection Class loaded via function");

    $plugins = $plugin_type->getPlugins();
    $this->assertTrue($plugins instanceof \Drupal\sps\Plugin\PluginCollection,
      "Plugin Collection Class loaded via function");
  }

  /**
   * Reuse this in other plugin test to verify the plugin interface is correct
   *
   * @param $plugin
   */
  protected function assertIsPlugin($plugin) {
    $this->assertCheckInterface("Drupal\\sps\\Plugin\\PluginInterface", $plugin, "Invalid Plugin");
  }

  /**
   * Check if the class is a certain plugin type
   */
  protected function assertIsPluginType($plugin, $type) {
    $interface = 'Drupal\\sps\\Plugin\\Type\\' . $type . "Interface";
    $this->assertCheckInterface($interface, $plugin, "Plugin is of type $type");
  }
}

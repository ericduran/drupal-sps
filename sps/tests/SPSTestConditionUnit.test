<?php
class SPSTestConditionUnitTest extends SPSBaseUnitTest {
  static function getInfo() {
    return array(
      'name' => 'SPS Test Condition Unit Tests',
      'description' => 'Test the public interface to the Test Condition object',
      'group' => 'SPS',
    );
  }

  public function testTestCondition() {
    $manager = self::getManager();
    $settings = array(
      'element_form' => array(
        'test' => array(
          '#markup' => 'This is Test Markup',
        ),
      ),
      'validate_fail_message' => "There was an error",
      'validate_fail_name' => "error_item",
      'override' => new \Drupal\sps\Test\Override(array(), $manager),
    );
    $condition = new \Drupal\sps\Test\Condition($settings, $manager);
    $form = array();
    $form_state = array();
    $this->assertEqual(
      $condition->getElement($form, $form_state),
      $settings['element_form'],
      "TestCondition::getElement should return the element_form from settings", 'SPS'
    );
    $this->assertEqual(
      $condition->getOverride(),
      NULL,
      "TestCondition::getOverride should return NULL if the submit has not yet been called", 'SPS'
    );

    form_clear_error();
    $condition->validateElement($form, $form_state);
    $this->assertEqual(
      form_get_errors(),
      array($settings['validate_fail_name'] => $settings['validate_fail_message']),
      "TestCondition::validateElement should log a form error if validate_fail_message or validate_Fail_name are set", 'SPS'
    );
    $condition->submitElement($form, $form_state);
    $this->assertEqual(
      $condition->getOverride(),
      $settings['override'],
      "TestCondition::getOverride should return the override in settings if submitElement has been called", 'SPS'
    );
  }

  public function testBasicCondition() {
    $manager = self::getManager();

    $settings = array(
      'override' => new \Drupal\sps\Test\Override(array(), $manager),
      'widget' => new \Drupal\sps\Test\Widget(array(), $manager)
    );

    //BasicCondition should take configuration and the manager in constructor i.e. implement PluginInterface
    $condition = new \Drupal\sps\Plugins\Condition\BasicCondition($settings, $manager);
    $this->assertCheckInterface('Drupal\sps\Plugins\PluginInterface', $condition, "BasicCondition should implement Drupal\sps\Plugins\PluginInterface");

    //BasicCondition should construct the correct widget and properly get its form
    $test_widget = new \Drupal\sps\Test\Widget(array(), $manager);
    $state = array();
    $widget = $test_widget->getPreviewForm(array(), $state);

    $state = array();
    $element = $condition->getElement(array(), $state);
    //for right now, we're just assuming the widget's form will be a sub array of the condition form, we should refine this
    if (!in_array($widget, $element)) {
      $this->fail('BasicCondition should construct the correct widget from the settings and properly return its form.');
    }
    else {
      $this->pass('BasicCondition should construct the correct widget from the settings and properly return its form.');
    }

    //BasicCondition should validate the form through the widget
    $condition->validateElement($element, array());

    $errors = form_get_errors();
    if (empty($errors)) {
      $this->fail('BasicCondition should validate form through widget - Failed to add form error.');
    }
    else {
      $this->pass('BasicCondition should validate form through widget - Properly added form error.');
    }
    form_clear_error();

    $good_state = array(
      'values' => array(
        'text_input' => 'value'
      )
    );

    $condition->validateElement($element, $good_state);
    $errors = form_get_errors();
    if (empty($errors)) {
      $this->pass('BasicCondition should validate form through widget - Properly passed validation.');
    }
    else {
      $this->fail('BasicCondition should validate form through widget - Error given in good state.');
    }

    //BasicCondition should return false for getOverride if the form hasn't been submitted.
    $override = $condition->getOverride();
    $this->assertEqual($override, FALSE, 'BasicCondition should return false for getOverride when form is not yet submitted.');

    //BasicCondition should submit the form properly and pass the values to the override.
    $condition->submitElement($element, $good_state);
    $override = $condition->getOverride();

    $this->assertEqual($override->getOverrides(), $good_state['values'],
      'BasicCondition should properly extract values from widget and pass them to Override after submit.');
  }

  public function testAggregatorOverride() {
    $table1 = array(
      'panels' => array(
        12 => 123,
        43 => 11,
        4500 => 3,
      ),
    );

    $table2 = array(
      'node' => array(
        11 => 12,
        43 => 10,
      ),
    );

    $table3 = array(
      'box' => array(
        'twitter_pull-testing' => 11
      ),
    );

    $endGoal = array(
      'node' => array(
        11 => 12,
        43 => 10,
      ),
      'box' => array(
        'twitter_pull-testing' => 11
      ),
      'panels' => array(
        12 => 123,
        43 => 11,
        4500 => 3,
      ),
    );

    $manager = self::getManager();

    $override1 = new \Drupal\sps\Test\Override(array(), $manager);
    $override2 = new \Drupal\sps\Test\Override(array(), $manager);
    $override3 = new \Drupal\sps\Test\Override(array(), $manager);

    $override1->setData($table1);
    $override2->setData($table2);
    $override3->setData($table3);

    $aggregator = new \Drupal\sps\Plugins\Override\AggregatorOverride();
    $aggregator->setData(array($override1, $override2, $override3));
    $this->assertEqual($aggregator->getOverride(), $endGoal, 'AggregatorOverride should combine overrides.');
  }
  /**
   * Helper function to return a manager object for passing into plugins
   */
  protected static function getManager() {
    $state_controller = new Drupal\sps\Test\StorageController();
    $override_controller = new Drupal\sps\Test\StorageController();
    $config_controller = new Drupal\sps\Test\StorageController();
    $plugin_controller = new Drupal\sps\Test\PluginController(array());
    return new Drupal\sps\Manager($state_controller, $override_controller, $config_controller, $plugin_controller);
  }
}

<?php
class SPSManagerUnitTest extends SPSBaseUnitTest {
  static function getInfo() {
    return array(
      'name' => 'SPS Manager Unit Tests',
      'description' => 'Test the public interface to the Manager object',
      'group' => 'SPS',
    );
  }

  public function testManager_getNullSiteState() {
    $env = $this->getManagerEnv();
    $manager = $env->manager;
    $this->assertNull($manager->getSiteState(), "Manager::getSiteState should return null if there is no state", "SPS");
  }
  public function testManager_getPersistentSiteState() {
    $env = $this->getManagerEnv();
    $manager = $env->manager;
    $state_controller = $env->state_controller;

    $table = array(array("id"=> 1, "revision_id" => 2, "type"=>"bob"));
    $override = new \Drupal\sps\Test\Override(array(), $manager);
    $override->setData($table);
    $site_state = new Drupal\sps\SiteState($env->override_controller, $override);

    $state_controller->set($manager->getStateControllerSiteStateKey(), $site_state);
    $this->assertEqual($manager->getSiteState(), $site_state, "Manager::getSiteState returns a site_state storred in the persistent data", "SPS");
  }
  public function testManager_setSiteState() {
    $env = $this->getManagerEnv();
    $manager = $env->manager;
    $override_controller = $env->override_controller;
    $state_controller = $env->state_controller;

    $table = array(array("id"=> 1, "revision_id" => 2, "type"=>"bob"));
    $override = new \Drupal\sps\Test\Override(array(), $manager);
    $override->setData($table);
    $manager->setSiteState($override);

    $site_state = new Drupal\sps\SiteState($override_controller, $override);
    $this->assertEqual($state_controller->get($manager->getStateControllerSiteStateKey()), $site_state, "Manager::setSiteState construct the site_state and put it in site_state_controller", "SPS");

  }
  public function testManager_PluginAccess() {
    $env = $this->getManagerEnv();
    $manager = $env->manager;
    $info = array(
      'widget' => array(
        'test_widget' => array(
          'class' => '\Drupal\sps\Test\Override',
          'instance_settings' => array(),
        ),
      ),
    );
    $env->plugin_controller->setInfo($info);

    $this->assertEqual(
      $manager->getPluginInfo('widget'),
      $info['widget'],
      "TestStorageController::getPluginInfo should get me all of the plugin infos for that type if i only pass it one param", 'SPS'
    );
    $this->assertEqual(
      $manager->getPluginInfo('widget', 'test_widget'),
      $info['widget']['test_widget'],
      'TestStorageController::getPluginInfo should get the plugin info for  the plugin when passed two param', 'SPS'
    );
    $this->assertEqual(
      $manager->getPlugin('widget', 'test_widget'),
      new \Drupal\sps\Test\Override(array(), $manager),
      'TestStorageController::getPlugin should build a obj from the plugin info', 'SPS'
    );

  }
  public function testManager_previewForm() {
    $env = $this->getManagerEnv();
    $manager = $env->manager;
    $override = new \Drupal\sps\Test\Override(array(), $manager);
    $override->setData(array(array('id'=>1, 'revision_id' =>3, 'type' => 'article')));
    $settings = array(
      'element_form' => array(
        'test' => array(
          '#markup' => 'This is Test Markup',
        ),
      ),
      'validate_fail_message' => "There was an error",
      'validate_fail_name' => "error_item",
      'override' => $override,
    );

    $info = array(
      'condition' => array(
        'testCondition' => array(
          'class' => '\Drupal\sps\Test\Condition',
          'instance_settings' => $settings,
        ),
      ),
    );
    $env->plugin_controller->setInfo($info);
    //set drupal_get_from to just return what was passed in
    $env->hook_controller->setDrupalGetForm("sps_condition_preview_form", function($callable) {
      return $callable;
    });
    $config_controller = $env->config_controller;
    $config_controller->set(SPS_CONFIG_ROOT_CONDITION, array("name" => 'testCondition', 'config' => array()));

    $condition = $manager->getPlugin("condition", 'testCondition');
    $form = array();
    $form_state = array();
    $this->assertEqual(
      $manager->getPreviewForm($form, $form_state),
      array($condition, 'getElement'),
      "Manager::getPreviewForm find the root condition and then returns a form sps_condition_preview_form constucted with the getElement method of the condition", 'SPS'
    );
    //TODO this need to test previewFormSubmitted()
    /*
    $manager->submitPreviewForm($form, $form_state);
    $site_state = $manager->getSiteState();
    $this->assertEqual(
      $site_state->getOverride(),
      $override->getOverrides(),
      "Manager::submitPreviewForm summits the from to the root condition, as the former for the override and builds the site state with that override.", 'SPS'
    );
    */
  }

  public function testManager_react() {
    $settings = array(
      'callback' => function($data) { return $data + 1;},
    );
    $info = array(
      'reaction' => array(
        'test_reaction' => array(
          'class' => '\Drupal\sps\Test\Reaction',
          'instance_settings' => $settings,
        ),
      ),
    );
    $env = $this->getManagerEnv();
    $manager = $env->manager;
    $env->plugin_controller->setInfo($info);
    $this->assertEqual(
      $manager->react("test_reaction", 4),
      5,
      "Manager::react should return based on the react method of the plugin", 'SPS'
    );
  }
  public function testManager_getHookController() {
    $env = $this->getManagerEnv();
    $this->assertEqual(
      $env->manager->getHookController(),
      $env->hook_controller,
      "Manager::getHookController should return the registered hook controller", 'SPS'
    );
    
  }

  protected function getManagerEnv() {
    $env = new stdClass();
    $env->state_controller = new \Drupal\sps\Test\StorageController();
    $env->override_controller = new \Drupal\sps\Test\StorageController();
    $env->config_controller = new \Drupal\sps\Test\StorageController();
    $env->plugin_controller = new \Drupal\sps\Test\PluginController(array());
    $env->hook_controller = new \Drupal\sps\Test\HookController();
    $env->manager = new \Drupal\sps\Manager($env->state_controller, $env->override_controller, $env->config_controller, $env->plugin_controller, $env->hook_controller);
    return $env;
  }

}
